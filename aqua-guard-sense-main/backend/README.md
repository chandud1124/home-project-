# Water Tank Monitoring System - Backend

## Setup Instructions

1. Install Node.js and npm
2. Navigate to the backend folder
3. Install dependencies:
   ```bash
   npm install
   ```
4. Start the server:
   ```bash
   npm run dev
   ```

## API Endpoints

### Tank Management
- `GET /api/tanks` - Get current tank levels
- `POST /api/tanks/reading` - Add new tank reading

### Motor Control
- `POST /api/motor/control` - Control motor (start/stop)
- `GET /api/motor/events` - Get motor event history

### System Monitoring
- `GET /api/alerts` - Get system alerts
- `POST /api/alerts` - Add new alert
- `GET /api/system/status` - Get system status
- `POST /api/system/status` - Update system status

### Analytics
- `GET /api/consumption?period=daily|monthly` - Get consumption data

## Real-time Transport (Updated)

Legacy WebSocket server replaced by Supabase Edge Function using:
- **SSE (Server-Sent Events)** for browser realtime downstream
- **HTTPS POST** for telemetry & command enqueue
- **Polling Endpoint** for device command retrieval

Command Queue Endpoints (Edge Function `websocket`):
1. Enqueue command:
```
POST /functions/v1/websocket
{ "type": "enqueue_command", "target_device_id": "SUMP_TANK_1", "command_type": "motor_start", "payload": {"requested_by":"ui"} }
```
2. Poll commands:
```
GET /functions/v1/websocket?poll=1&device_id=SUMP_TANK_1
```
3. Acknowledge command:
```
POST /functions/v1/websocket
{ "type": "acknowledge_command", "device_id": "SUMP_TANK_1", "command_id": "<uuid>", "status": "success" }
```

Telemetry POST Wrapper:
```json
{
   "apikey": "<anon key>",
   "type": "sensor_data|motor_status|system_alert|ping",
   "data": {"...": "..."},
   "firmware_version": "2.1.0",
   "build_timestamp": "2025-09-06T00:00:00Z"
}
```

## Database

Uses SQLite database stored in `water_tank.db`

## Device Key Fallback (Optional)
If a device has not yet been inserted into `esp32_devices`, the server can fall back to a local JSON map.

Sources (in merge order):
1. `backend/device_keys.json` (local file, NOT committed; copy from `device_keys.json.example` and edit)
2. `DEVICE_KEYS_JSON` environment variable containing a JSON object

Example `device_keys.json` entry:
```json
{
  "ESP32_SUMP_002": {
    "api_key": "<api_key>",
    "hmac_secret": "<hmac_secret>",
    "device_type": "sump_tank"
  }
}
```
Values here are only used when no row exists in `esp32_devices` (or legacy `devices`). Prefer inserting/upserting via SQL generated by `node scripts/generate-device-keys.js`.

### Batch Device Key Generation
Use the batch script to create multiple devices at once.

Examples:
```
# Generate two devices (prints SQL, secrets snippets, JSON)
npm run gen:devices -- ESP32_SUMP_003:sump_tank ESP32_TOP_002:top_tank

# Write/merge into backend/device_keys.json (ignored by git)
npm run gen:devices -- --write-file backend/device_keys.json ESP32_EDGE_001:unknown

# Force overwrite existing entries in file
npm run gen:devices -- --write-file backend/device_keys.json --force ESP32_SUMP_003:sump_tank

# Only SQL output
npm run gen:devices -- --sql-only ESP32_TEST_A:lab

# Only secrets snippets
npm run gen:devices -- --snippets-only ESP32_TEST_B:lab
```
Result sections:
- SQL: upsert statements for Supabase `esp32_devices` table
- secrets.h snippets: copy one block per firmware build into `esp32/secrets.h`
- JSON Map: can be saved as `backend/device_keys.json` or used for `DEVICE_KEYS_JSON` env var

## Deployment to Supabase and Firebase

### Supabase Setup
1. Create/link Supabase project: `supabase link --project-ref <your-ref>`
2. Deploy functions: `supabase functions deploy`
3. Update ESP32 `BACKEND_HOST` to your Supabase URL (e.g., `your-project.supabase.co`)
4. Set `BACKEND_USE_TLS = true` and `BACKEND_PORT = 443`

### Firebase Setup
1. Initialize: `firebase init` (select Hosting)
2. Build frontend: `npm run build`
3. Deploy: `firebase deploy --only hosting`

### ESP32 Integration
- Updated all sketches to use Supabase project URL: `aqua-guard-sense-main.supabase.co`
- Paths: `/functions/v1/api/sensor-data`, etc.
- Supabase api function now handles ESP32 routes: sensor-data, motor-status, heartbeat, system-alert.
- Deploy functions: `supabase functions deploy`

### Supabase Project
- URL: https://dwcouaacpqipvvsxiygo.supabase.co
- Set SUPABASE_KEY in environment for backend.
- Link project: `supabase link --project-ref dwcouaacpqipvvsxiygo`
